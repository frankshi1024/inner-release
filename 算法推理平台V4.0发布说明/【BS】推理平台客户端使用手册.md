# 推理平台使用手册

> Powered by 极视角

[TOC]



## 一、算法部署：安装/部署算法实例

### 1. 准备工作：配置K8S token

*获取token，请参考“master节点部署/单机部署文档-num7”部分内容：[(master&node)节点部署说明/文字版](https://release1024.oss-ap-southeast-1.aliyuncs.com/算法推理平台/V4.0/部署/2-master·node节点部署.html)

#### （1）获取K8Stoken

![](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-26-082254.jpg)

#### （2）在控制台·环境参数·监控服务中，填写宿主机IP及获取到的token

![屏幕快照 2019-07-27 上午11.11.33](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-031346.png)

### 2. 安装/部署算法实例

#### （1）进入算法商店

通过右上角的算法商店入口，可以查看当前系统提供的所有算法，点击“安装算法”按钮；

![image-20190727111449208](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-031450.png)

#### （2）安装/部署算法实例

· 选择要部署的服务器IP，并设置算法对外服务的端口；

其中，单节点服务集群的IP一般为master节点IP，当系统实现了多节点（node）部署时，IP就可以选择其他服务器IP。

通过“添加安装参数”，可以同时部署多个算法实例。

![image-20190727111847772](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-031849.png)

· 确认安装信息是否正确，点击“立即安装”，算法即进入安装状态。

![image-20190727112312199](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-032314.png)

· 通过右上角的进度查看（沙漏）按钮，可以查看安装任务（一般最新的安装任务在最下端），安装成功/失败后会有弹窗提示。

![image-20190727112004327](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-032005.png)

· 安装完成的算法，可以在“控制台·环境参数·算法服务地址”中查看，如图所示，其中选中的端口号为65534的算法即为刚刚安装完成的算法。

至此，算法的安装/部署环节全部完成。

![image-20190727112057167](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-032059.png)

## 二、算法激活

### 1. 获取激活码

*请通过线下渠道获取相关算法的激活码。

### 2. 算法激活/延续前版本功能

将获取到的激活码填写到输入框中，点击“立即激活”，即可激活当前算法；请注意选择的算法是否为激活码对应算法。

![image-20190727113126098](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-033127.png)

## 三、算法配置

### 1. 准备工作：环境参数设置

#### （1）流媒体服务配置及callback地址配置

*在前序工作中，我们已经完成了K8S底层调度服务的配置以及算法服务地址的自动获取，在算法真正能用之前，我们还需要完成其他两项准备工作。

##### · 流媒体服务

该服务一般安装在master节点，当然如果有其他需求也可以根据情况安装。在新版本的算法推理平台中，默认端口如图中所示，分别为31935和30080.

![image-20190727114045497](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-034047.png)

##### · callback地址

本机默认callback地址为：http://192.168.1.175:81/api/callback/handle

你也可以根据客户需要设置其他的callback地址。

![image-20190727141718304](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-061720.png)

#### （2）视频算法分析配置

- 视频类算法的分析配置，与之前的相比在页面样式上做了一些调整，但数据结构是跟前序版本保持一致的，即"摄像头——算法1、算法2..."这样的结构。

![image-20190727143944255](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-063946.png)

- 点击左上角"新增"按钮，可以添加新的输入源（摄像头），在列表中，现在可以直观地看到该输入源的流地址。

![image-20190727144920099](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-064922.png)


- 点击右侧的"添加算法"按钮，可以添加新的算法
- 算法参数相较于之前的版本保持一致：

| 参数                      | 说明                                                         | 备注                                                         |
| ------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 选择算法                  | 在添加时为可选，即系统支持的算法                             |                                                              |
| 摄像头ID                  | 即CID，在配置时已固定                                        |                                                              |
| 算法开始时间&算法结束时间 | 即算法运行的时间区间，在该区间外算法将会停止服务             | 有时候会遇到客户反馈算法没有分析的情况，可能就是因为设置了该参数 |
| 结果回调地址              | 即callback地址，是算法报警结果的推送地址                     |                                                              |
| 抽帧间隔                  | 算法服务（vas）通过当前输入源（即该CID对应的直播流）取帧间隔，在实际部署使用时可以适当延长间隔时间 | 如果算法用于演示，则可以将该参数设置为0                      |
| docker服务地址            | 即安装好的算法实例地址                                       |                                                              |
| 报警上传间隔              | 即推送报警信息到callback地址的间隔，如在10s内发生了2次以上报警，则实际仅推送一次 | 适当延长间隔，可以减少对客户的打扰                           |

![image-20190727144814375](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-064816.png)

#### （3）图片算法分析配置
- 该功能与前序版本保持一致。
- 图片算法分析配置，适用于已经实现图片算法封装的算法并经过系统集成的算法，目前下图中所示算法即为当前版本支持的算法。
- 点击"管理"可以查看该算法的详情。

![](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-065155.png)

- 配置详情，可以查看当前配置的所有信息：

| 参数       | 作用                                                         | 备注 |
| ---------- | ------------------------------------------------------------ | ---- |
| 备注名称   | 用于区分该配置，建议加上作用相关信息                         |      |
| 输入源类型 | 目前我们仅支持（http）post请求类型的输入源                   |      |
| 分析频率   | 即针对同一个输入源（CID）的算法分析间隔，如设置为10s，则在10s内，该算法针对当前CID最多分析1次请求，其他请求将被丢弃 |      |
| CID        | 即输入源ID，一般请根据实际的业务系统对照来设置               |      |

![](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-065507.png)

![image-20190727150250842](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-070252.png)

#### （4）算法输出配置

- 算法输出配置，在当前版本专指针对“图片类算法”的输出配置，能够实现针对图片类算法报警结果的二次过滤，从而辅助提高算法精准度，满足一定的业务需求（如不需要过于频繁的报警）。

![image-20190727151401119](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-071403.png)

- 具体参数的意义如下：

| 参数                      | 说明                                                         | 备注 |
| ------------------------- | ------------------------------------------------------------ | ---- |
| 配置名称                  | 用于说明该配置的具体作用                                     |      |
| 选择算法类型              | 支持图片类/视频的算法输出过滤                                |      |
| 选择算法                  | 选择已配置了“图片算法分析配置”的图片类算法                   |      |
| 关联输入源                | 在上述配置中，已关联的输入源，具体要过滤哪些；如果不在该范围内，即不推送报警 |      |
| 监控时长                  | 是“触发条件”中的一个参数，为一个监控周期                     |      |
| 本地触发次数              | 触发报警条件的次数                                           |      |
| 触发条件说明              | 几个参数的组合触发条件，是对算法输出结果做的二次过滤         |      |
| *针对“触发条件”的综合说明 | 如图中所示，配置后的意思为“在60s内，当算法输出为aid==9500的次数达到一次，则触发报警” |      |
| 报警结果转发地址          | 即callback地址，这里的配置要分为两种情况：视频类，如果要做报警结果转发，则在“视频算法分析配置”中的callback中必须要选择；图片类的报警结果转发地址直接在此处维护。 |      |

![image-20190727154843234](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-074846.png)



## 四、其他功能概述

### 1. 报警记录

如果算法报警地址/callback地址设置的有本地地址，则会在本机的报警记录中查看相关信息，点击图片可以查看大图。

![image-20190727180432360](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-100434.png)

### 2. 报警音效

- 算法的报警音效需要用户自行上传，点击“替换”就可以上传自定义的音效。
- 该音效用于在接收到实时报警的时候，在浏览器中进行语音播放。（关掉浏览器或系统声音后将无法播放音效）
- 当前报警音效方案不支持报警设备联动。

![image-20190727180944915](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-100946.png)

### 3. 数据集管理及联邦学习

该功能主要用于联邦学习算法学习与应用；已经标注过的数据集，可以在“联邦学习”模块进行算法的本地训练，训练完成后将会把算法模型的权重文件上传至云端，实现算法模型的本地化/场景化优化。

![image-20190727181919177](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-101920.png)

![image-20190727181935004](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-101936.png)

![image-20190727181946690](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-101948.png)

![image-20190727182004343](http://mark-pic.oss-ap-southeast-1.aliyuncs.com/2019-07-27-102005.png)