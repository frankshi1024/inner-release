# 演示功能开发技术建议

> Powered by 极视角

## 一、背景说明

该技术建议基于<u>已经安装部署完毕的极视角算法管理系统</u>给出，基于现有的系统接口，可以完成部分演示功能的开发。

## 二、技术建议

### **1.** 算法返回的分析结果视频流

#### （1）RTMP协议推拉流

##### 视频流地址

```
rtmp://docker服务地址/echostream/摄像头id_算法id
例：rtmp://192.168.1.57/echostream/911001_9510
```

##### 推荐测试播放器

该分析结果视频流可以直接通过播放器播放，推荐测试播放器：VLC

https://www.videolan.org

##### 开发建议

- 我们的算法管理及演示服务，通过html+flash的方式实现，一般可以借用这种方式快速实现前端演示功能的自主开发；
- rtmp视频流使用移动设备（tablet等）的技术方案目前并未做技术探索，如果要采用这类方案，请注意相应的技术风险。

#### （2）HLS实时流

##### 拉流地址

格式：`http://docker宿主机ip:port/echostream/cid_aid/playlist.m3u8`

例如：`http://192.168.1.30:8000/echostrean/123450_9510/playlist.m3u8`

##### 服务开发方法

（默认不开启）

A. 定位配置文件nginx.conf

在服务器上找到rtmp docker目录，找到nginx.conf 

```
/usr/local/nginx
├── nginx           # 主程序
├── nginx.conf      # 运行配置文件
├── script          # 脚本目录
    ├── nginx_start.sh             # nginx启动脚本 
    ├── nginx_stop.sh              # nginx停止脚本 
    ├── log_packAndDelete.sh       # 历史按天打包脚本 
    ├── rtmp_control_on_capture.sh # 手动抓图脚本
├── nginx_data      # 图片、视频存储目录
    ├── logs            # 日志目录
        ├── nginx.pid                  # 程序运行时存在，存放主进程id 
        ├── error.log                  # nginx 运行日志
        ├── http_access.log            # http请求日志 
        ├── rtmp_access.log            # rtmp请求日志 
    ├── capture         # 抓图片存放目录 
    ├── hls             # hls实时流存放目录 
    ├── flv             # rtmp实时流录像存放目录 
... 更多内容省略
```

B. 开启服务

修改第61行代码“off” — >"on"，如下图所示；

![开启hls直播流](http://markdown-1024.oss-cn-shenzhen.aliyuncs.com/%E7%AE%97%E6%B3%95/%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1/%E5%BC%80%E5%90%AFhls%E7%9B%B4%E6%92%AD%E6%B5%81.png)



#### （3）流媒体服务完整概述

流媒体基于nginx+rtmp方案实现，安装目录`/usr/local/nginx`

目录结构如下

```
/usr/local/nginx
├── nginx           # 主程序
├── nginx.conf      # 运行配置文件
├── script          # 脚本目录
    ├── nginx_start.sh             # nginx启动脚本 
    ├── nginx_stop.sh              # nginx停止脚本 
    ├── log_packAndDelete.sh       # 历史按天打包脚本 
    ├── rtmp_control_on_capture.sh # 手动抓图脚本
├── nginx_data      # 图片、视频存储目录
    ├── logs            # 日志目录
        ├── nginx.pid                  # 程序运行时存在，存放主进程id 
        ├── error.log                  # nginx 运行日志
        ├── http_access.log            # http请求日志 
        ├── rtmp_access.log            # rtmp请求日志 
    ├── capture         # 抓图片存放目录 
    ├── hls             # hls实时流存放目录 
    ├── flv             # rtmp实时流录像存放目录 
... 更多内容省略
```

##### rtmp协议推拉流

默认启用

- 推拉流地址

格式：`rtmp://docker宿主机IP:port/echostream/cid_aid`

例如：`rtmp://192.168.1.30/echostream/123450_0000`

- 验证

vlc播放器验证，或网页播放器验证

例如： `http://winlinvip.github.io/srs.release/trunk/research/players/srs_player.html?`

sample验证

容器内算法目录下**libffmpeg_player.so,testPaly,testPlayAndRtmp**程序验证，把文件拷贝至docker宿主机上，并确保宿主机上安装了ffmpeg,openCV,glog等库；

##### nginx增加抓图功能

默认启用

- 请求地址

格式：`http://docker宿主机ip:port/capture/start?cid_url=流地址`

例如：`http://192.168.1.30:8000/capture/start?cid_url=rtsp://admin:extremevision201@192.168.1.34:554/h264/ch1/sub/av_stream`

- 返回

返回200时，有如下json数据,例如：

```
    "result": 0,
    "pic_data":"base64编码的图像数据"
```

其中resut为0时代表抓图成功，并且有pic_data;其它代表抓图失败. 

##### hls实时流

默认不启用

- 拉流地址

格式：`http://docker宿主机ip:port/echostream/cid_aid/playlist.m3u8`

例如：`http://192.168.1.30:8000/echostrean/123450_9510/playlist.m3u8`

##### flv录像

默认不启用

### **2.** 报警推送（websocket）

> 我们的报警信息推送采用web socket的技术手段，实现报警信息的即时推送。
>

#### 简要描述

- 客户端websocket 使用

#### 地址加端口

- `192.168.1.110:5200`

#### 连接方式

- javascript
  ws = new WebSocket(“ws://192.168.1.110:5200”);
- php
  引用的第三方websocket包， <https://packagist.org/packages/aiwhj/swoole-websocket-client>
  $client = new WebSocket(‘192.168.1.110’, 5200);

#### 备注

javascript或者安卓或者ios客户端成功连接上websocket后，需要在客户端实现心跳检测功能。具体见心跳检测



#### websocket 连接 参数

无

#### 返回示例

```
{
    "response": {
        "heartbeat_interval": 10, ### 客户端websocket的心跳检测时间间隔
        "msg": "ws connect success" 
    }
}
```

#### websocket 心跳检测参数

```
{"action":"ping"}
```

#### 返回示例

```
{
    "response": {
        "msg": "ping ok!"
    }
}
```

#### websocket 报警提醒 参数（php使用）

```
{
    "data": [{
        "record_id": 9,
        "alarm_name": "行人越界",
        "created_time": "2018-10-08 08:01:20"
    }],
    "action": "alarm"  ####报警
}
```



#### 客户端（javascript）获取到的报警数据

```
{
    "response": {
        "data": [{
            "record_id": 89,
            "alarm_name": "行人越界",
            "created_time": "2018-10-09 01:57:11",
            "type": "alarm"
        }]
    }
}
```



### 3. 扩展建议：报警记录

> 我们的系统对报警记录同样做了存储，可以通过系统接口获取这些记录，并借此做更多的界面展示。当然，具体要实现怎样的功能，由开发者自行决定即可。

#### 简要描述

- 算法报警记录

#### 请求URL

```
/api/algo-alarm-record?startDate=2018-09-21 18:35:46&endDate=2018-09-29 18:35:46&algo_id=9580&status=1
```

#### 请求方式

- GET 

Headers：

URL参数：

| 参数名    | 必选 | 类型   | 说明                                                 |
| --------- | ---- | ------ | ---------------------------------------------------- |
| startDate | 否   | string | 开始时间，2018-09-21 18:35:46                        |
| endDate   | 否   | string | 结束时间，2018-09-29 18:35:46                        |
| algo_id   | 否   | int    | 报警类型（即算法id）                                 |
| status    | 否   | int    | 处理状态（-1，未处理; 1, 已处理；2，已处理（误报）） |

#### 返回示例

```
{
    "current_page": 1,
    "data": [
        {
            "record_id": 1,
            "algo_id": 9580,
            "cid": 911001,
            "rule_type": 1,
            "status": 1,
            "callback_image": null,
            "remark": "测试测试",
            "created_at": "2018-09-28 18:35:46",
            "updated_at": "2018-09-29 11:15:52",
            "algo_name": "离岗检测",
            "callback_image_url": "http://tool.test/storage/"
        },
        {
            "record_id": 2,
            "algo_id": 9580,
            "cid": 911001,
            "rule_type": 1,
            "status": 1,
            "callback_image": null,
            "remark": "测试测试",
            "created_at": "2018-09-28 18:35:46",
            "updated_at": "2018-09-29 11:15:52",
            "algo_name": "离岗检测",
            "callback_image_url": "http://tool.test/storage/"
        },
        {
            "record_id": 3,
            "algo_id": 9570,
            "cid": 23564,
            "rule_type": 1,
            "status": -1,
            "callback_image": "/callback_image/2018-09-29/23564/camera_f1c1592588411002af340cbaedd6fc33.jpg",
            "remark": null,
            "created_at": "2018-09-29 12:44:55",
            "updated_at": "2018-09-29 12:44:55",
            "algo_name": "",
            "callback_image_url": "http://tool.test/storage//callback_image/2018-09-29/23564/camera_f1c1592588411002af340cbaedd6fc33.jpg"
        },
        {
            "record_id": 4,
            "algo_id": 9540,
            "cid": 27,
            "rule_type": 1,
            "status": -1,
            "callback_image": "/callback_image/2018-09-29/27/camera_f1c1592588411002af340cbaedd6fc33.jpg",
            "remark": null,
            "created_at": "2018-09-29 12:53:59",
            "updated_at": "2018-09-29 12:53:59",
            "algo_name": "",
            "callback_image_url": "http://tool.test/storage//callback_image/2018-09-29/27/camera_f1c1592588411002af340cbaedd6fc33.jpg"
        },
        {
            "record_id": 5,
            "algo_id": 9540,
            "cid": 27,
            "rule_type": 1,
            "status": -1,
            "callback_image": "/callback_image/2018-09-29/27/camera_f1c1592588411002af340cbaedd6fc33.jpg",
            "remark": null,
            "created_at": "2018-09-29 12:55:51",
            "updated_at": "2018-09-29 12:55:51",
            "algo_name": "",
            "callback_image_url": "http://tool.test/storage//callback_image/2018-09-29/27/camera_f1c1592588411002af340cbaedd6fc33.jpg"
        },
        {
            "record_id": 6,
            "algo_id": 9580,
            "cid": 2312,
            "rule_type": 1,
            "status": -1,
            "callback_image": "/callback_image/2018-09-29/2312/camera_f1c1592588411002af340cbaedd6fc33.jpg",
            "remark": null,
            "created_at": "2018-09-29 12:57:05",
            "updated_at": "2018-09-29 12:57:05",
            "algo_name": "离岗检测",
            "callback_image_url": "http://tool.test/storage//callback_image/2018-09-29/2312/camera_f1c1592588411002af340cbaedd6fc33.jpg"
        },
        {
            "record_id": 7,
            "algo_id": 9580,
            "cid": 2312,
            "rule_type": 1,
            "status": -1,
            "callback_image": "/callback_image/2018-09-29/2312/camera_f1c1592588411002af340cbaedd6fc33.jpg",
            "remark": null,
            "created_at": "2018-09-29 12:57:28",
            "updated_at": "2018-09-29 12:57:28",
            "algo_name": "离岗检测",
            "callback_image_url": "http://tool.test/storage//callback_image/2018-09-29/2312/camera_f1c1592588411002af340cbaedd6fc33.jpg"
        },
        {
            "record_id": 8,
            "algo_id": 9580,
            "cid": 2312,
            "rule_type": 1,
            "status": -1,
            "callback_image": "/callback_image/2018-09-29/2312/camera_f1c1592588411002af340cbaedd6fc33.jpg",
            "remark": null,
            "created_at": "2018-09-29 12:58:42",
            "updated_at": "2018-09-29 12:58:42",
            "algo_name": "离岗检测",
            "callback_image_url": "http://tool.test/storage//callback_image/2018-09-29/2312/camera_f1c1592588411002af340cbaedd6fc33.jpg"
        }
    ],
    "first_page_url": "http://tool.test/api/algo-alarm-record?page=1",
    "from": 1,
    "last_page": 1,
    "last_page_url": "http://tool.test/api/algo-alarm-record?page=1",
    "next_page_url": null,
    "path": "http://tool.test/api/algo-alarm-record",
    "per_page": 10,
    "prev_page_url": null,
    "to": 8,
    "total": 8
}
```

####  备注

```
更多返回错误代码请看首页的错误代码描述
```

